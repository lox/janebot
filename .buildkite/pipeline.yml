agents:
  queue: hosted

cache:
  paths:
    - "~/.local/share/mise"
    - "~/.cache/mise"
    - "~/.local/state/mise"
  size: "20g"
  name: "mise-cache"

env:
  MISE_YES: "1"
  MISE_TRUSTED_CONFIG_PATHS: /buildkite/builds

steps:
  - label: ":typescript: Typecheck"
    command: pnpm install && pnpm typecheck

  - label: ":test_tube: Test"
    command: pnpm install && pnpm test

  - label: ":package: Build"
    command: pnpm install && pnpm build

  - label: ":docker: Sandbox Image"
    command: |
      docker build -f Dockerfile.sandbox -t ghcr.io/buildkite/janebot-sandbox:${BUILDKITE_COMMIT} .
      if [[ "${BUILDKITE_BRANCH}" == "main" ]]; then
        echo "$GHCR_TOKEN" | docker login ghcr.io -u buildkite --password-stdin
        docker push ghcr.io/buildkite/janebot-sandbox:${BUILDKITE_COMMIT}
        docker tag ghcr.io/buildkite/janebot-sandbox:${BUILDKITE_COMMIT} ghcr.io/buildkite/janebot-sandbox:latest
        docker push ghcr.io/buildkite/janebot-sandbox:latest
      fi
    secrets:
      - GHCR_TOKEN

  - wait

  - block: ":rocket: Deploy to Staging"
    if: build.pull_request.id != null

  - label: ":fly: Deploy Staging"
    if: build.pull_request.id != null
    command: flyctl deploy --config fly.staging.toml --remote-only
    secrets:
      - FLY_API_TOKEN_STAGING

  - wait

  - label: ":fly: Deploy Production"
    branches: main
    command: flyctl deploy --config fly.toml --remote-only
    secrets:
      - FLY_API_TOKEN_PRODUCTION
